---

copyright:
  years: 2018, 2019
lastupdated: "2019-06-11"

keywords: fairness, fairness monitor, payload, perturbation, training data, debiased

subcollection: ai-openscale

---

{:shortdesc: .shortdesc}
{:external: target="_blank" .external}
{:tip: .tip}
{:important: .important}
{:note: .note}
{:pre: .pre}
{:codeblock: .codeblock}
{:download: .download}
{:screen: .screen}
{:javascript: .ph data-hd-programlang='javascript'}
{:java: .ph data-hd-programlang='java'}
{:python: .ph data-hd-programlang='python'}
{:swift: .ph data-hd-programlang='swift'}
{:faq: data-hd-content-type='faq'}

# 配置公平性監視器
{: #mf-monitor}

在 {{site.data.keyword.aios_full}} 中，公平性監視器會掃描您的部署是否有偏誤，以確保不同族群之間的輸出結果是公平的。
{: shortdesc}

## 瞭解公平性
{: #mf-understand}

{{site.data.keyword.aios_short}} 會在執行時期檢查所部署模型的偏誤。如果要偵測所部署模型的偏誤，您必須定義公平性屬性（例如「年齡」或「性別」），如下列[配置「公平性」監視器](#mf-config)一節中所詳述。

請務必在 Watson {{site.data.keyword.pm_short}} 中，指定模型或函數的輸出綱目，才能在 {{site.data.keyword.aios_short}} 中啟用偏誤檢查。您可以在 `store_model` API 的 meta 資料部分中，使用 `client.repository.ModelMetaNames.OUTPUT_DATA_SCHEMA` 內容來指定輸出綱目。如需相關資訊，請參閱 [{{site.data.keyword.pm_full}} 用戶端說明文件](http://wml-api-pyclient-dev.mybluemix.net/#repository){: external}。

### 如何運作
{: #mf-works}

在您配置「公平性」監視器之前，有一些重要的概念務必要瞭解。

- 公平性屬性是指模型有可能顯現偏誤的模型屬性。以公平性屬性 **`Gender`** 為例，模型可能對於特定的性別值（`Female`、`Transgender` 等）有偏誤。另以公平性屬性 **`Age`** 為例，模型可能對於某年齡群（例如 `18 to 25`）的人群顯現偏誤。

- 參照值和受監視值：公平性屬性的值分成兩個不同的種類：「參照」和「受監視」。「受監視」值是指要作為判別對象的那些值。對於 **`Gender`** 等之類的公平性屬性而言，「受監視」值可以是 `Female` 和 `Transgender`。對於 **`Age`** 等之類的數值型公平性屬性而言，「受監視」值可以是 `[18-25]`。給定公平性屬性的其他所有值則可視為參照值，例如 `Gender=Male` 或 `Age=[26,100]`。

- 有利和不利輸出結果：模型的輸出會分類成「有利」或「不利」。舉例來說，如果模型預測某人是否應取得貸款，則「有利」輸出結果可以是 `Loan Granted` 或 `Loan Partially Granted`，而「不利」輸出結果可能是 `Loan Denied`。因此，「有利」輸出結果就是被視為正面輸出結果的那一個，而「不利」輸出結果則被視為負面。

{{site.data.keyword.aios_short}} 演算法會使用有效負載記載表格中所呈現的最近 `N` 筆記錄，每小時計算一次偏誤；`N` 值是在配置「公平性」時指定的。演算法會擾動這最近 `N` 筆記錄，以產生額外的資料。

擾動的作法是將公平性屬性的值從「參照」變更為「受監視」，反之亦然。之後會將擾動資料傳送給模型，以評估其行為。演算法會查看有效負載表格中的最近 `N` 筆記錄，以及查看模型在擾動資料上的行為，來決定模型是否以偏誤的方式執行。

在這個組合的資料集中，如果「受監視」類別的「有利」輸出結果百分比，小於「參照」類別的「有利」輸出結果百分比達到某個臨界值，就會將該模型視為有偏誤。此臨界值是在配置「公平性」時指定的。

公平性值可以超過 100%。這表示「受監視」群組所收到的有利輸出結果超過「參照」群組。此外，只要沒有傳送任何新的評分要求，「公平性」值會維持不變。
{: note}

### 數學計算
{: #mf-bias-math}

{{site.data.keyword.aios_short}} 中使用的公平性度量是差別影響，這是比對特權群組收到特定輸出結果或結果的比率，來測量無特權群組收到相同輸出結果或結果的比率。

下列數學公式用來計算差別影響：

```
                     (num_positives(privileged=False) / num_instances(privileged=False))
差別影響 =         ______________________________________________________________________

                     (num_positives(privileged=True) / num_instances(privileged=True))
```

其中，`num_positives` 是群組中收到正面輸出結果的個體數目（privileged=False，代表無特權；privileged=True，代表特權），num_instances 是群組中的個體總數。

產生的數字是一個百分比，亦即，非特許群組收到正面輸出結果，佔特許群組收到正面輸出結果的比率。例如，例如，如果信用風險模型將「無風險」預測指派給 80% 的非特許申請者，以及指派給 100% 的特許申請者，則該模型的差別影響（在 {{site.data.keyword.aios_short}} 中會呈現成公平性評分）為 80%。

在 {{site.data.keyword.aios_short}} 中，正面輸出結果會指定成有利輸出結果，負面輸出結果會指定成「不利」輸出結果。特許群組會指定成參照群組，非特許群組則指定成受監視群組。


### 偏誤視覺化 ![測試版標記](images/beta.png)
{: #mf-monitor-bias-viz}

當偵測到潛在的偏誤時，{{site.data.keyword.aios_short}} 會執行一些功能，來確認該偏誤是否是真的。{{site.data.keyword.aios_short}} 會擾動資料，其作法是將受監視值翻轉成參照值，然後透過模型執行這筆記錄。接著，它會將產生的輸出顯現成已除去偏誤的輸出。{{site.data.keyword.aios_short}} 也會訓練一個已除去偏誤的投影模型，然後用它來偵測模型何時做出有偏誤的預測。 

會使用兩個不同的資料集來計算公平性和精確度。公平性是以「有效負載 + 擾動資料」來計算。精確度是以回饋資料來計算。為了計算精確度，{{site.data.keyword.aios_short}} 需要手動標示資料，這只會呈現在回饋表格中。

這些判定的結果會提供於偏誤視覺化中，其中包含下列視圖： 

- **有效負載 + 擾動**：如果未符合評估所需的最低記錄數目，則包含所選那個小時內所收到的評分要求，外加過去幾個小時內的其他記錄。如果受監視特性的值有變更，會包含用來測試模型回應的其他擾動/合成記錄。

   請留意下列的有效負載和擾動明細：

   - 在這個小時內從有效負載表格讀取的記錄數目
   - 從過去幾個小時所讀取的其他記錄（例如，如果公平性配置中的 `min_records` 值設為 1000，而下午 2 點到 3 點之間只新增了 10 筆記錄，為了符合最低需求，系統會從過去幾個小時額外讀取 990 筆記錄。）
   - 各公平性屬性的擾動記錄
   - 必須計算其偏誤之資料框架中最舊記錄的時間戳記
   - 必須計算其偏誤之資料框架中最新/最近記錄的時間戳記

  ![有效負載外加擾動的範例](images/payload&perturbed.png)



- **有效負載**：模型在所選那個小時內所收到的實際評分要求。

   請留意下列的有效負載明細：
   
   - 已從有效負載表格讀取/對其執行除去偏誤作業的記錄數
   - 必須計算其偏誤之資料框架中最舊記錄的時間戳記
   - 必須計算其偏誤之資料框架中最新/最近記錄的時間戳記


  ![有效負載資料範例](images/payload.png)

- **訓練**：用來訓練模型的訓練資料記錄。

   請留意下列的訓練明細：
   
   - 訓練資料記錄數目。訓練資料會讀取一次，並將分佈儲存在 `subscription/fairness_configuration` 變數中。在計算分佈期間，我們也應會找到訓練資料記錄數目，並將它儲存在相同的分佈中。此外，當訓練資料變更時（表示是否再次執行 `POST /data_distribution` 指令），會在 `fairness_configuration/training_data_distribution` 變數中更新此值。在傳送度量期間，我們應該也會傳送此值。
   - 前次處理（第一次和後續的更新）訓練資料的時間

  ![訓練資料範例](images/training.png)
   

   
- **除去偏誤**：處理執行時期和擾動資料之後的除去偏誤演算法的輸出。

   請留意下列的除去偏誤明細：
   
   - 已從有效負載表格讀取/對其執行除去偏誤作業的記錄數
   - 為執行偏誤而讀取，從而已除去偏誤的其他記錄。會與`有效負載 + 擾動`選擇項中的數目相同
   - 各公平性屬性的擾動記錄
   - 必須計算其偏誤之資料框架中最舊記錄的時間戳記
   - 必須計算其偏誤之資料框架中最新/最近記錄的時間戳記
   - 前後公平性值會顯示在「已除去偏誤」視圖的標頭部分中 
      - **後**精確度的計算方式是，取得回饋表格中的資料，並傳送給作用中的除去偏誤 API。此 API 會傳回已除去偏誤的預測。回饋資料也會包含手動標籤。手動標籤會與已除去偏誤的預測相互比較，以計算精確度。此 API 會傳回已除去偏誤的預測。回饋表格也會包含手動標籤。手動標籤會與已除去偏誤的預測相互比較，以計算精確度。 
      - **前**精確度是以相同的回饋資料來計算。就前精確度的計算來說，會傳送回饋資料給模型，以取得其預測，並將預測值與手動標籤相互比較，以取得精確度。

  ![除去偏誤資料範例](images/debiased.png)
  
### 範例
{: #mf-ex1}

假設有一個資料點，其中 `Gender=Male`（「參照」值），模型預測為「有利」輸出結果，但是當將 `Gender` 變更為 `Female`（「受監視」值），來擾動記錄時，儘管其他所有的特性值都維持相同，模型卻預測為「不利」輸出結果。如果資料點足夠（有效負載表格中的最近 `N` 筆記錄，外加擾動資料），但模型在這些資料點中卻以偏誤的方式執行，則該模型整體來說是顯現偏誤。

### 支援的模型
{: #mf-supmo}

 {{site.data.keyword.aios_short}} 只支援對那些模型以及預期其特性向量中存在某種結構化資料的 Python 函數，執行偏誤偵測。

## 配置「公平性」監視器
{: #mf-config}

從**公平性**標籤，在**何謂公平性？**頁面中，按一下**開始**，啟動配置處理程序。

![「何謂公平性？」頁面](images/fair-what-is.png)

在這項處理程序中，{{site.data.keyword.aios_full}} 會分析您的模型，並根據最合邏輯的輸出結果提供建議。在**公平性**標籤的後續頁面中，您必須執行下列作業：

1. 選取要監視的特性。只支援種類、數值（整數）、浮點或倍精準數公平性資料類型的特性。不支援其他資料類型的特性。
    

1. 指定參照和受監視群組。

   每一項特性都有特定的需求要配置。例如，如果您選擇 `age` 作為其中一項受監視的特性，您必須直接在**參照群組**和**受監視群組**中輸入值，以定義每一個群組的年齡範圍。

1.  針對特性，設定公平性警示臨界值。

    「公平性」臨界值用來指定相較於「參照」群組的「有利」輸出結果百分比，對於「受監視」群組的「有利」輸出結果百分比，所能接受的差異。

    假設模型會預測何人應取得貸款 (`favorable outcome=loan granted`)，何人不應取得貸款 (`unfavorable outcome=loan denied`)。再者，年齡的「受監視」值是 `[18,25]`，「參照」值是 `[26,100]`。當執行偏誤偵測演算法時，如果發現在最近 `N` 筆記錄外加擾動資料中，年齡群 `[18,25]` 之人群的「有利」輸出結果百分比是 `50%`，而年齡群 `[26,100]` 之人群的「有利」輸出結果百分比是 `70%`，則所算出的「公平性」會是 50*100/70 = 71.42。

    如果「公平性」臨界值設為 80%，則演算法會將模型標示為有偏誤，這是因為所算出的「公平性」超出臨界值。不過，如果臨界值設為 70%，就不會將模型報告為有偏誤。

     您在這些畫面中輸入的值，應會成為要傳送給模型評分端點的值（因而會新增至有效負載表格中）。如果資料在傳送給評分端點之前會先進行操作，請輸入操作後的值。例如，如果原始資料的 *Gender* 值是 `Male` 和 `Female`，且經過操作，以致於傳送給評分端點的資料是 `M` 和 `F`，請在此畫面上輸入 `M` 和 `F`。

1.  請指定一些值來代表模型的有利輸出結果。如果模型輸出綱目含有對映直欄，則這些值是衍生自[訓練資料](/docs/services/ai-openscale?topic=ai-openscale-trainingdata#trainingdata)中的 `label` 直欄。在 {{site.data.keyword.pm_full}} 中，`prediction` 直欄一律具有倍精準數值。對映直欄用來指定這個 `prediction` 值指向類別標籤的對映。

    例如，如果 `prediction` 值是 `1.0`，對映直欄的值可能是 `Loan denied`；這意味著模型的預測是 `Loan denied`。因此，如果模型輸出綱目包含對映直欄，請使用對映直欄中的值來指定「有利」值和「不利」值。

    不過，如果模型輸出綱目中沒有對映直欄，則需要使用 `prediction` 直欄的值（`0.0`、`1.0` 等）來指定「有利」值和「不利」值。

1.  最後，設定樣本大小下限，以便在評估資料集中的可用記錄數目未達下限之前，阻止測量「公平性」。這是確保樣本大小不會太小而扭曲結果。每當執行偏誤檢查時，會使用樣本大小下限來決定將執行偏誤計算的記錄數目。

    會呈現您的選擇摘要，供您檢閱。只要您想變更，請針對該區段按一下**編輯**鏈結，否則，請按一下**儲存**。

    您也可以按一下**新增另一項特性**，回到特性選擇畫面，並將其他特性（例如 `City`、`Zip Code` 或 `Account Balance`）新增至「公平性」監視器。

### 瞭解除去偏誤如何運作
{: #mf-debias}

如果要檢查除去偏誤端點，請按一下**除去偏誤端點**按鈕。然後以不同格式（例如：cURL、Java 或 Python）來檢視及複製端點。 

已除去偏誤的評分端點可完全當成所部署模型正常的評分端點使用。除了傳回所部署模型的回應之外，還會傳回 `debiased_prediction` 和 `debiased_probability` 直欄。

- `debiased_prediction` 直欄含有已除去偏誤的預測值。對 {{site.data.keyword.pm_full}} 而言，這是以編碼方式來表示預測。例如，如果模型預測是 "Loan Granted" 或 "Loan Denied"，{{site.data.keyword.pm_full}} 可將這兩個值分別編碼成 "0.0" 和 "1.0"。`debiased_prediction` 直欄含有這類以編碼方式來表示已除去偏誤的預測。

- 在另一方面，`debiased_probability` 直欄代表已除去偏誤之預測的機率。這是一個倍精準數值陣列，其中，每一個值各代表已除去偏誤之預測（屬於其中一個預測類別）的機率。

假設您的輸出綱目中有一個直欄，且該直欄含有一個 `modeling-role` 設為 `decoded-target` 的直欄，也會傳回另一個直欄 `debiased_decoded_target`。

- `debiased_decoded_target` 直欄會以字串來表示已除去偏誤的預測。在上述範例中，預測值是 "0.0" 或 "1.0"，`debiased_decoded_target` 將包含 "Loan Granted" 或 "Loan Denied"。

理論上，您會從正式作業應用程式直接呼叫此端點，而不是直接呼叫部署在模型處理引擎（{{site.data.keyword.pm_full}}、Amazon Sagemaker、Microsoft Azure ML Studio 等）中之模型的評分端點。這樣一來，{{site.data.keyword.aios_short}} 也會將 `debiased` 值儲存在您模型部署的有效負載記載表格中。之後，凡是透過此端點來完成的評分都會自動除去偏誤。

由於此端點會處理執行時期偏誤，它會繼續對有效負載記載表格中的最新評分資料執行背景檢查，並持續更新偏誤減輕模型（此模型用來去除所傳送之評分要求的偏誤）。在此情況下，{{site.data.keyword.aios_short}} 一律保有最新的送入資料，且其在偵測及減輕偏誤的行為上也會保持最新。

最後，{{site.data.keyword.aios_short}} 使用臨界值決定該資料現在是可接受的，且可視為無偏誤。對於在「公平性」監視器中設定給所配置之所有公平性屬性的臨界值中，會以該臨界值作為最小值。

## 後續步驟
{: #mf-next}

從**配置監視器**頁面，您可以選取另一個監視種類。
